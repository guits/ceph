[tox]
envlist = testinfra, mypy, flake8
skipsdist = true

[base]
setenv =
    HOME = {homedir}
    PWD = {toxinidir}

[flake8]
max-line-length = 120
exclude =
  .tox
  .mypy_cache

[testenv:testinfra]
setenv =
  {[base]setenv}
  ANSIBLE_SSH_ARGS = -F {toxinidir}/vagrant_ssh_config -o ControlMaster=auto -o ControlPersist=600s -o PreferredAuthentications=publickey
  ANSIBLE_FORCE_COLOR = true
  ANSIBLE_KEEP_REMOTE_FILES = 1
whitelist_externals =
  vagrant
  bash
deps =
  ansible
  testinfra>=3,<4
  pytest-xdist==1.28.0
  pytest>=4.6,<5.0
commands =
  vagrant up
  bash -x generate_ssh_config.sh
  bash -x {toxinidir}/build_container_img.sh
  ansible-playbook -vv -i {toxinidir}/hosts {toxinidir}/deploy.yml
  py.test -n 8 --durations=0 --sudo -v --connection=ansible --ansible-inventory={toxinidir}/hosts --ssh-config={toxinidir}/vagrant_ssh_config {toxinidir}/tests

[testenv:mypy]
deps =
  mypy
setenv =
    MYPYPATH = {toxinidir}/..
passenv =
    MYPYPATH
basepython = python3
mypy_args = features/
commands =
    mypy {[testenv:mypy]mypy_args}
    mypy --python-version 3.9 {[testenv:mypy]mypy_args}

[testenv:flake8]
deps =
    flake8==3.9.2
commands = flake8 --statistics {posargs} features/
